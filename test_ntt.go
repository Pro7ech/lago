package main

import (
	"github.com/dedis/student_18_lattices/bigint"
	"fmt"
	"github.com/dedis/student_18_lattices/kyber"
	"github.com/LoCCS/bliss/poly"
	"github.com/dedis/student_18_lattices/ring"
	"github.com/dedis/student_18_lattices/polynomial"
)

func main() {
	N := uint32(256)
	Q := bigint.NewInt(7681)
	// Two set of coefficients (polynomials)
	p1 := ring.NewUniformPoly(N, *Q, *bigint.NewInt(7681))
	//coeffs1 := p1.GetCoefficientsInt64()
	p2 := ring.NewUniformPoly(N, *Q, *bigint.NewInt(7681))
	//coeffs2 := p2.GetCoefficientsInt64()

	coeffs1 := []int64{7224502, 2919427, 3713160, 3787640, 2701349, 1635448, 5734849, 5953790, 2166378, 116041, 4939022, 4703713, 6308390, 912870, 1791720, 6944693, 6571407, 784469, 3670217, 6830161, 1400993, 7157632, 8233214, 3674333, 5041701, 5242862, 4957786, 5387589, 2499219, 4620563, 5569612, 2186855, 1098901, 4157219, 1179351, 4845623, 1492747, 2016486, 4988450, 6860211, 6846314, 5591453, 4628802, 4509916, 2858006, 6427031, 6967340, 3465695, 3310809, 45233, 4564782, 2239220, 2279848, 556866, 4285627, 2501943, 6209751, 6077799, 2189969, 5975094, 1189601, 4625160, 5566158, 5225939, 1069588, 7018406, 6322475, 3540971, 5343604, 4699275, 670608, 2629061, 6209797, 4267188, 2364988, 1649592, 1997040, 4550508, 8231150, 2936989, 2915163, 1726398, 6804161, 2363753, 2599528, 7961204, 4959199, 5438133, 6003917, 6801664, 2734656, 4014166, 5546959, 6474054, 7079070, 516352, 902364, 1260589, 7643748, 3806059, 6592376, 1899669, 4537965, 6358730, 4993485, 6587046, 7559637, 3841611, 6103039, 7270137, 1542227, 837536, 1100608, 2682704, 5093238, 5272166, 4315812, 1338921, 4867858, 6105118, 4549527, 620265, 974220, 4664798, 8048691, 1718066, 2173991, 7434828, 119152, 4366557, 1472818, 6677180, 7436625, 3908464, 6383995, 2512853, 8287670, 2774729, 7074339, 3768114, 3590350, 4481747, 385390, 3424815, 5469414, 720839, 314115, 5399371, 881142, 6321675, 302105, 971931, 7795986, 843231, 6008760, 1908493, 2435067, 8060089, 1735202, 3697214, 6616510, 6323715, 2686226, 7014612, 1475829, 4583363, 624252, 8151647, 248183, 833622, 7234041, 2638934, 4923646, 6548043, 1255793, 6703813, 2407743, 3326344, 8230583, 1338721, 3771055, 8122238, 7027328, 640440, 8058448, 4029033, 5091843, 2601903, 8299427, 7915302, 6769739, 4615812, 2342752, 2484956, 6497058, 5276464, 5244144, 1078722, 3114629, 5379186, 2451015, 6524172, 5912535, 8262594, 6197428, 3184461, 5137631, 4176241, 8228884, 6716713, 2912150, 7705261, 1094606, 7465898, 8283311, 4767199, 648669, 5087803, 1292919, 3011414, 488881, 5040423, 2482702, 5268845, 1403405, 3131377, 5808812, 611420, 7890466, 3455565, 5914562, 1220162, 6535640, 2767813, 6353022, 281456, 1561595, 2663823, 5769048, 807332, 7013057, 5718323, 1173221, 6717056, 7678467, 4561150, 5331862, 6958432, 2427624, 5961579, 3264127, 8342069, 3227124, 2332709, 5925054, 4789068}
	coeffs2 := []int64{6084867, 7038980, 1260492, 2191890, 6814120, 7546172, 586650, 47313, 28237, 5594791, 7399016, 5488684, 5151078, 1725559, 3123294, 6087351, 3612346, 7901068, 1458295, 2138040, 3024127, 8075273, 7723492, 1821441, 6626709, 379247, 2700109, 2812668, 5201982, 5900086, 7782935, 1352136, 4761243, 1819046, 7756230, 4748737, 6374158, 1233226, 6498447, 1375148, 8336806, 6698590, 5704628, 4161580, 1928624, 1408023, 1514135, 6670145, 6735609, 627855, 7206772, 3155370, 4597354, 592067, 5679381, 6921823, 938998, 5864626, 7498210, 735966, 3257569, 7024445, 1811577, 8308371, 5647697, 8347679, 6761329, 4671813, 1387163, 1167601, 4758564, 7382939, 7847351, 4687892, 3640739, 4099106, 1742952, 3888037, 7636384, 925061, 5201314, 1818256, 3643470, 1281757, 1506040, 5902297, 6543928, 1398764, 2366173, 3444166, 6265176, 1537901, 1576653, 3377495, 3259590, 639611, 3676032, 5881953, 5904823, 8320969, 2831996, 1868965, 7328706, 4301144, 6728978, 1652615, 77127, 6840623, 4457406, 2225966, 1798783, 2800316, 6667026, 7983315, 1632814, 1528685, 6518100, 5297809, 7713931, 1477486, 3672837, 199270, 3122719, 5791663, 1988031, 7814752, 1734298, 5811841, 3060355, 5302058, 2080825, 7142115, 5927356, 6928939, 705101, 7612543, 7236538, 6391409, 1732785, 8055915, 6345963, 4935497, 4423584, 5344427, 461268, 2535343, 4811240, 3186563, 4969330, 4136545, 8266579, 2560891, 1453369, 4671353, 674857, 4105647, 1828889, 4759376, 847353, 3540193, 5399377, 3977904, 2284576, 3730723, 5607999, 5465311, 7322825, 6847087, 2153915, 320443, 5599993, 1699757, 7256547, 8100762, 5090016, 7502051, 4621360, 1502457, 3303525, 5747434, 7673502, 449464, 5220971, 8002514, 7346998, 4606679, 5669080, 530395, 3929058, 3683436, 5343740, 6617520, 655495, 7915113, 6043978, 2017071, 3617978, 5210090, 1671898, 243069, 7024332, 4180189, 7648613, 6514715, 5669493, 4847454, 8278317, 8192455, 3721069, 3156799, 2854785, 6458173, 4997106, 4352746, 6194584, 6646022, 461894, 5560106, 3572523, 3708947, 2405690, 5950282, 7314759, 1784582, 7953402, 876348, 5988272, 5264072, 1793801, 4262149, 594672, 7628396, 1352880, 6151294, 5572899, 1959889, 1327314, 5171529, 3563719, 5638010, 6684455, 2272778, 3104258, 5841859, 3402978, 6493560, 6662510, 7490528, 2427513, 1256567, 3292377, 6778465, 4394741, 3572904, 568619, 7428654}
	// kyber.NTT
	coeffs1Kyber := [256]uint16{}
	coeffs2Kyber:= [256]uint16{}
	for i := range coeffs1Kyber {
		coeffs1Kyber[i] = uint16(coeffs1[i])
		coeffs2Kyber[i] = uint16(coeffs2[i])
	}

	kyber.NttRef(&coeffs1Kyber)
	kyber.NttRef(&coeffs2Kyber)
	for i := range coeffs1 {
		coeffs1Kyber[i] = kyber.MontgomeryReduce(uint32(coeffs1Kyber[i]) * uint32(coeffs2Kyber[i]))
	}
	kyber.InvnttRef(&coeffs1Kyber)
	for i := range coeffs1 {
		coeffs1Kyber[i] = kyber.Freeze(coeffs1Kyber[i])
	}
	nttResultKyber := coeffs1Kyber
	fmt.Printf("Kyber : %v\n", nttResultKyber)


	//bliss.NTT
	coeffs1Bliss := make([]int32, N)
	coeffs2Bliss := make([]int32, N)
	for i := range coeffs1Bliss {
		coeffs1Bliss[i] = int32(coeffs1[i])
		coeffs2Bliss[i] = int32(coeffs2[i])
	}
	p1Bliss, _ := poly.New(0)
	p2Bliss, _ := poly.New(0)
	p1Bliss.SetData(coeffs1Bliss)
	p2Bliss.SetData(coeffs2Bliss)

	p1BlissNTT, _ := p1Bliss.NTT()
	nttResultBliss, _ := p2Bliss.MultiplyNTT(p1BlissNTT)
	fmt.Printf("Bliss : %v\n", nttResultBliss)


	//our.NTT
	p := ring.NewRing(N, *Q)
	p.MulPoly(p1, p2)
	nttResultOur := p.GetCoefficientsInt64()
	fmt.Printf("Our   : %v\n", nttResultOur)

	//our.FastNTT
	p1.Poly.NTT()
	fmt.Printf("Our NTT: %v\n", p1.GetCoefficientsInt64())
	p1.Poly.InverseNTT()
	fmt.Printf("Inv NTT: %v\n", p1.GetCoefficientsInt64())
	p1.Poly.FastNTT()
	fmt.Printf("FastNTT: %v\n", p1.GetCoefficientsInt64())

	//our.DebugNTT
	params, _ := polynomial.GenerateNTTParameters(N, *Q)
	psiReverse := make([]int64, N)
	psiInvReverse := make([]int64, N)
	for i := range psiReverse {
		psiReverse[i] = params.PsiReverseMontgomery[i].Int64()
		psiInvReverse[i] = params.PsiInvReverseMontgomery[i].Int64()
	}
	fmt.Printf("\nori coeffs: %v\n", coeffs1)
	coeffsNtt := polynomial.DebugNTT(coeffs1,psiReverse,7681, 256)
	coeffsIntt := polynomial.DebugInverseNTT(coeffsNtt, psiInvReverse, 7681, 256)
	fmt.Printf("cur coeffs: %v\n", coeffsIntt)
}
